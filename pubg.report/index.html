<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>pubg.report w/o TDM</title>
        <script
			  src="https://code.jquery.com/jquery-3.6.0.min.js"
			  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
			  crossorigin="anonymous"></script>
        <link rel="stylesheet" href="style.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,500&display=swap" rel="stylesheet">
    </head>
    <body>
        <h1 class="site-title">PUBG.report without TDM</h1>
        <form action="#" method="get" name="form-search">
            <input type="text" name="search" class="search-player" placeholder="Enter your PUBG username (PC only)">
        </form>
        <div id="reports"></div>
    </body>
    <script>
        let mapData;
        $.getJSON("https://raw.githubusercontent.com/pubg/api-assets/master/dictionaries/telemetry/mapName.json")
        .then(function(data) {
            mapData = data;
        })

        function getPlayerData(player_id) {
            $.get(`https://api.pubg.report/v1/players/${player_id}/streams`)
                .then(function(response) {
                    let reports_parsed = parseShittyTdm(response)
                    Object.keys(reports_parsed).forEach(function(key) {
                        reports_parsed[key].forEach(function(value) {
                            $("#reports").append(`
                        <a href="https://www.twitch.tv/videos/${value.VideoID.replace('v', '')}?t=${parseTimeForTwitchVod(value.TimeDiff)}" class="video-link" target="_blank">
                            <div class="report ${parseEvent(value.Event)["class"]}" id="${value.ID}">
                                <p class="date">${value.Date}</p>
                                <h3>${value.Killer}</h3>
                                <p><span class="${parseEvent(value.Event)["class"]}">${parseEvent(value.Event)["msg"]}</span> <strong>${value.Victim}</strong></p>
                                <div class="inline-info">
                                    ${parseEvent(value.Event)["teammate"] ? "<span class=\"tag\">Teammate's POV</span>": ''}
                                    <span class="tag">${parseMode(value.Mode)[0]}</span>
                                    <span class="tag">${parseMode(value.Mode)[1]? parseMode(value.Mode)[1]: "TPP"}</span>
                                    <span class="tag">${mapData[value.Map]}</span>
                                </div>
                            </div>
                        </a>
                    `)
                        })
                    })
                })
        }

        function parseShittyTdm(resp) {
            Object.keys(resp).forEach(function(key) {
                Object.keys(resp[key]).forEach(function(key2) {
                    if (resp[key][key2].Mode === "tdm") {
                        delete resp[key][key2];
                    }
                })
                if ($.isEmptyObject(resp[key])) {
                    delete resp[key];
                }
            })
            return resp;
        }

        function parseTimeForTwitchVod(time) {
            time = time.split(":")
            switch(time.length) {
                case 2:
                    return `${time[0]}m${time[1]}s`;
                case 3:
                    return `${time[0]}h${time[1]}m${time[2]}s`;
            }
        }

        function parseEvent(event) {
            switch (event) {
                case "LogPlayerKill":
                    return {
                        "msg": "killed",
                        "class": "killed"
                    };
                case "LogPlayerMakeGroggy":
                    return {
                        "msg": "knocked",
                        "class": "knocked"
                    };
                case "LogPlayerDeath":
                    return {
                        "msg": "killed",
                        "class": "killed-by"
                    };
                case "LogPlayerMadeGroggy":
                    return {
                        "msg": "knocked",
                        "class": "knocked-by"
                    };
                case "LogTeammateKill":
                    return {
                        "msg": "killed",
                        "class": "killed teammate-pov",
                        "teammate": true
                    }
            }
        }

        function parseMode(mode) {
            return mode.split("-");
        }

        $("form[name=form-search]").submit(function (e) {
            e.preventDefault()
            let username = e.target[0].value;
            $.get(`https://api.pubg.report/search/${username}`)
            .then(function (response) {
                getPlayerData(response[0].id);
            })
        })
    </script>
</html>